#include <GUIConstantsEx.au3>
#include <MsgBoxConstants.au3>
#include <FileConstants.au3>
#include <EditConstants.au3>
#include <WindowsConstants.au3>
#include <WinAPIShPath.au3>

MDictGUI()

Func MDictGUI()
$hGUI1 = GUICreate("mdictGui 0.5.6", 517, 516, 192, 125)

$idButton_Descr = GUICtrlCreateButton("Descripton", 45, 18, 80, 22)
GUICtrlCreateInput("File Descripton(UTF8)", 140, 18, 260, 32, BitOR($GUI_SS_DEFAULT_INPUT,$ES_MULTILINE))

$GroupPackMDX = GUICtrlCreateGroup("Pack MDX", 24, 56, 393, 88)
$idButton_BrowseUnp = GUICtrlCreateButton("Select MTXT", 45, 72, 80, 22)
GUICtrlCreateInput("Source Mdict", 140, 72, 260, 32, BitOR($GUI_SS_DEFAULT_INPUT,$ES_MULTILINE))
$idButton_Pack = GUICtrlCreateButton("Make MDX", 45, 103, 80, 22)
$idButton_vers = GUICtrlCreateButton("MdictVers", 440, 16, 58, 24)
$idButton_ConvSqlit = GUICtrlCreateButton("Convert sqlite3", 140, 110, 80, 22)
GUICtrlCreateGroup("", -99, -99, 1, 1)

$GroupUnPackMDX = GUICtrlCreateGroup("UnPack MDX", 25, 166, 393, 97)
$idButton_BrowsePack = GUICtrlCreateButton("Select MDX", 45, 192, 80, 22)
GUICtrlCreateInput("File MDX", 134, 192, 260, 32, BitOR($GUI_SS_DEFAULT_INPUT,$ES_MULTILINE))
$idButton_UnPack = GUICtrlCreateButton("Unpack MDX", 44, 223, 80, 22)
$idButton_Meta = GUICtrlCreateButton("Show Meta info", 314, 232, 80, 22)
GUICtrlCreateGroup("", -99, -99, 1, 1)

$GroupPackMDD = GUICtrlCreateGroup("Pack MDD", 29, 282, 393, 80)
$idButton_BrowseDir = GUICtrlCreateButton("Folder MDD", 45, 300, 80, 22)
GUICtrlCreateInput("Dir MDD", 134, 300, 260, 32, BitOR($GUI_SS_DEFAULT_INPUT,$ES_MULTILINE))
$idButton_PackMDD = GUICtrlCreateButton("Make MDD", 45, 329, 80, 22)

GUICtrlCreateGroup("", -99, -99, 1, 1)

$GroupUnPackMDD = GUICtrlCreateGroup("UnPack MDD , Sqlite3 DB", 30, 384, 393, 97)
$idButton_BrowseMDD = GUICtrlCreateButton("Select File", 45, 410, 80, 22)
$idButton_UnMDD = GUICtrlCreateButton("Unpack MDD", 45, 441, 80, 22)
GUICtrlCreateInput("File MDD or DB", 139, 410, 260, 32, BitOR($GUI_SS_DEFAULT_INPUT,$ES_MULTILINE))
$idButton_UnpSqlite3 = GUICtrlCreateButton("Unpack Sqlite3", 140, 450, 80, 22)
GUICtrlCreateGroup("", -99, -99, 1, 1)

GUISetState(@SW_SHOW)
        Local $iPIDPack = 0
	    Local $iPIDUnPack = 0
		Local $iPIDPackMDD = 0
	    Local $iPIDUnMDD = 0
		Local $iPIDMeta =0
		Local $iPIDvers =0
		Local $iPIDconv_db = 0
		Local $iPIDUn_db = 0
		Local  $sDesc=0
		Local  $sUnp=0
		Local  $sPack=0
		Local  $sUnMDD=0
		Local  $sPackMDD=0

	; Display the GUI
	GUISetState(@SW_SHOW, $hGUI1)

	   ; Display a message of whether the file exists or Exit.
	   Local $iFileExists = FileExists("mdict.exe")
	   If $iFileExists Then
           Else
If MsgBox(262209,"Check Mdict-utils","The mdict doesn't exist." & @CRLF & @CRLF & "Pls visit, " & "github/liuyug/mdict-utils" & @CRLF & "to download last 'mdict-windows'."& @CRLF & "Put mdictGui to 'mdict-windows'." & @CRLF) = 1 Then ShellExecute("https://github.com/liuyug/mdict-utils/releases")
             Exit
		EndIf

		; Initialize a Local RUN script.
	    Local $aMsg = 0
				RunWait(@ComSpec & " /c %SystemDrive%&&cd %temp%&&echo %cd%>temp.tmp", "", @SW_hide); create temp file to save %cd%
                $file = FileOpen(@TempDir & "\temp.tmp", 0)
                $line = FileReadLine($file)
		;------------------------------
		Local $aMsg = 0
	While 1
       ; Assign to $aMsg the advanced GUI messages.
		$aMsg = GUIGetMsg($GUI_EVENT_ARRAY)
				Switch $aMsg[0]
					Case $GUI_EVENT_CLOSE
						ExitLoop
					EndSwitch

				; Switch from event Open Descr----------------------------1
				Switch $aMsg[0]
					Case $idButton_Descr
        $sMessageDescr = "Please select a description file."
    $Descr = FileOpenDialog($sMessageDescr, @WindowsDir & "\", "Description File (*.*)", BitOR($FD_FILEMUSTEXIST, $FD_MULTISELECT))
If @error Then
	Else
    $Descr = StringReplace($Descr, "|", @CRLF)
        GUICtrlCreateInput($Descr, 140, 18, 260, 32 ,$ES_MULTILINE,$WS_EX_CLIENTEDGE)
		; Check file is encoding of UTF
		Local $iEncoding = FileGetEncoding($Descr) ; Retrieve the file encoding of the current script.
	If @error Then
		MsgBox(4096, "", "Error: Could not obtain the file encoding.")
	ElseIf Not($iEncoding =256) + ($iEncoding =128) Then
		MsgBox(4096, "", "You selected file Description:" & @CRLF & $Descr& @CRLF & @CRLF &"    Description is not UTF 8 !")
    Else
		$sDesc=1
         EndIf
			EndIf
				EndSwitch

                 ; Switch from event Open Mdict source MTXT-----------------2
				Switch $aMsg[0]
					Case $idButton_BrowseUnp
        $sMessageUnp = "Please select your Mdict source file."
    $Unp = FileOpenDialog($sMessageUnp, @WindowsDir & "\", "Mdict source (*.txt;*.mtxt)", BitOR($FD_FILEMUSTEXIST, $FD_MULTISELECT))
If @error Then
    Else
    $Unp = StringReplace($Unp, "|", @CRLF)
	$Un_=_WinAPI_PathRemoveExtension($Unp)
	$Un_=_WinAPI_PathRemoveExtension($Un_)
		$sUnp=1
        GUICtrlCreateInput($Unp, 140, 72, 260, 32 ,$ES_MULTILINE,$WS_EX_CLIENTEDGE)
	        EndIf
				EndSwitch

				; Switch from event Open MDX-------------------------------3
			    Switch $aMsg[0]
					Case $idButton_BrowsePack
		$sMessagePack = "Please select an MDX file."
     $Pack = FileOpenDialog($sMessagePack, @WindowsDir & "\", "Mdict file (*.mdx)", BitOR($FD_FILEMUSTEXIST, $FD_MULTISELECT))
	If @error Then
	Else
     $Pack = StringReplace($Pack, "|", @CRLF)
		$sPack=1
		GUICtrlCreateInput($Pack, 134, 192, 260, 32, $ES_MULTILINE,$WS_EX_CLIENTEDGE)
            EndIf
				EndSwitch

				; Switch from event Button_Pack MDX------------------------4
				Switch $aMsg[0]
				    Case $idButton_Pack
				 If $sUnp = 0 Then
				   MsgBox(4096, "", "You are not chosen Mdict source")
			  Else
				 If $sDesc = 0 Then
                   MsgBox(4096, "","You choose Mdict source:"& @CRLF & ""&$Unp&""& @CRLF &"will be pack without Description as:"&$Un_&".mdx")
				   $iPIDPack = Run("mdict -a "&$Unp&" "&$Un_&".mdx", "", @SW_SHOWNORMAL)
				 Else
				   MsgBox(4096, "","You choose Mdict source:"& @CRLF & ""&$Unp&""& @CRLF &"will be pack as:"&$Un_&".mdx")
				   $iPIDPack = Run("mdict --description "&$Descr&" -a "&$Unp&" "&$Un_&".mdx", "", @SW_SHOWNORMAL)
		        EndIf
			       EndIf
				EndSwitch

				; Switch from event Button_UnPack MDX -------------------------5
				Switch $aMsg[0]
					Case $idButton_UnPack
			     If $sPack = 0 Then
				   MsgBox(4096, "", "You are not chosen MDX file")
				 Else
				   MsgBox(4096, "","You choose MDX file:"& @CRLF & ""&$Pack&""& @CRLF &"will be unpack in dir: MDX")
				   $iPIDUnPack = Run("mdict -x "&$Pack&" -d ./mdx", "", @SW_SHOWNORMAL)
			EndIf
				EndSwitch

				; Switch from event Button_Metainfo------------------------6
				Switch $aMsg[0]
					Case $idButton_Meta
			     If $sPack = 0 Then
				   MsgBox(4096, "", "You are not chosen MDX file")
				 Else
				   Run("cmd /c",@SW_SHOW)
				   $iPIDMeta = Run(@ComSpec & " /k "&$line&"\mdict.exe -m "&$Pack&"", "", @SW_SHOWNORMAL)
			EndIf
				EndSwitch

				; Switch from event Button_Mdict_version-------------------7
				Switch $aMsg[0]
					Case $idButton_vers
                   Run("cmd /c",@SW_SHOW)
				   $iPIDvers = Run(@ComSpec & " /k "&$line&"\mdict.exe --version", "", @SW_SHOWNORMAL)
				EndSwitch

				; Switch from event SelectDir MDD---------------------------8
				Switch $aMsg[0]
					Case $idButton_BrowseDir
						$sMessageUnpMDD = "Please select your Mdd folder."
    $UnpMDD = FileSelectFolder($sMessageUnpMDD, "")
If @error Then
    Else
		$sUnMDD=1
        GUICtrlCreateInput($UnpMDD, 134, 300, 260, 32 ,$ES_MULTILINE,$WS_EX_CLIENTEDGE)
	EndIf
			EndSwitch

				; Switch from event Open MDD file----------------------------------9
			    Switch $aMsg[0]
					Case $idButton_BrowseMDD
		$sMessagePackMDD = "Please select an MDD/DB file."
     $PackMDD = FileOpenDialog($sMessagePackMDD, @WindowsDir & "\", "Open file (*.mdd;*.db)", BitOR($FD_FILEMUSTEXIST, $FD_MULTISELECT))
	If @error Then
	Else
     $PackMDD = StringReplace($PackMDD, "|", @CRLF)
		$sPackMDD=1
		GUICtrlCreateInput($PackMDD, 139, 410, 260, 32, $ES_MULTILINE,$WS_EX_CLIENTEDGE)
	    Local $sExt = StringRegExpReplace($PackMDD, "^.*\.", "")
	EndIf
			EndSwitch

				; Switch from event Button_Pack MDD-------------------------------10
				Switch $aMsg[0]
				    Case $idButton_PackMDD
				 If $sUnMDD = 0 Then
				   MsgBox(4096, "", "You are not chosen MDD source")
			  Else
				 If $sDesc = 0 Then
                   MsgBox(4096, "","You choose MDD source:"& @CRLF & ""&$UnpMDD&""& @CRLF &"will be pack without Description as:"& @CRLF &$UnpMDD&".mdd")
				   $iPIDPackMDD = Run("mdict -a "&$UnpMDD&" "&$UnpMDD&".mdd", "", @SW_SHOWNORMAL)
				 Else
				   MsgBox(4096, "","You choose Mdict source:"& @CRLF & ""&$UnpMDD&""& @CRLF &"will be pack as:"&$UnpMDD&".mdd")
				   $iPIDPackMDD = Run("mdict --description "&$Descr&" -a "&$UnpMDD&" "&$UnpMDD&".mdd", "", @SW_SHOWNORMAL)
		        EndIf
			       EndIf
			EndSwitch

				; Switch from event Button_UnPack MDD-------------------------------11
				Switch $aMsg[0]
					Case $idButton_UnMDD
			     If $sPackMDD = 0 Or $sExt = "db"  Then
				   MsgBox(4096, "", "You are not chosen MDD file")
				 Else
				   MsgBox(4096, "","You choose MDD file:"& @CRLF & ""&$PackMDD&""& @CRLF &"will be unpack in dir: MDD")
				   $iPIDUnMDD = Run("mdict -x "&$PackMDD&" -d ./mdd", "", @SW_SHOWNORMAL)
			     EndIf
				EndSwitch

				; Switch from event Button_UnPack MDD-------------------------------12
				Switch $aMsg[0]
					Case $idButton_UnpSqlite3
			     If $sPackMDD = 0 Or $sExt = "mdd"  Then
				   MsgBox(4096, "", "You are not chosen db file")
				 Else
				   MsgBox(4096, "","You choose Sqlite3 db file:"& @CRLF & ""&$PackMDD&""& @CRLF &"will be unpack as:"&$PackMDD&".txt")
				   $iPIDUn_db = Run("mdict --db-txt "&$PackMDD&"", "", @SW_SHOWNORMAL)
			     EndIf
				EndSwitch

				; Switch from event Button_ConvSqlit-------------------------------13
				Switch $aMsg[0]
				    Case $idButton_ConvSqlit
				 If $sUnp = 0 Then
				   MsgBox(4096, "", "You are not chosen Mdict source")
				 Else
                   MsgBox(4096, "","You choose Mdict source:"& @CRLF & ""&$Unp&""& @CRLF &"will be convert as:"&$Unp&".db")
				   $iPIDconv_db = Run("mdict --txt-db "&$Unp&"", "", @SW_SHOWNORMAL)
			       EndIf
				EndSwitch

	WEnd
	Run(@ComSpec & " /c taskkill /IM cmd.exe /F","",@SW_HIDE)
	GUIDelete($hGUI1)
	If $iPIDPack  Then ProcessClose($iPIDPack )
	If $iPIDUnPack Then ProcessClose($iPIDUnPack)
	If $iPIDPackMDD  Then ProcessClose($iPIDPackMDD )
	If $iPIDUnMDD Then ProcessClose($iPIDUnMDD)
	If $iPIDMeta Then ProcessClose($iPIDMeta)
	If $iPIDvers Then ProcessClose($iPIDvers)
	If $iPIDconv_db Then ProcessClose($iPIDconv_db)
	If $iPIDUn_db Then ProcessClose($iPIDUn_db)
EndFunc   ;==========
